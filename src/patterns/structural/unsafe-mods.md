# Содержание небезопасности в маленьких модулях

## Описание

Если у вас есть `unsafe` код, создайте наименьший возможный модуль, который может поддерживать необходимые инварианты для построения минимального безопасного интерфейса на основе небезопасности. Вставьте это в более крупный модуль, который содержит только безопасный код и представляет эргономичный интерфейс. Обратите внимание, что внешний модуль может содержать небезопасные функции и методы, которые напрямую вызывают небезопасный код. Пользователи могут использовать это, чтобы получить преимущества в скорости.

## Преимущества

- Это ограничивает небезопасный код, который должен быть проверен
- Написание внешнего модуля намного проще, так как вы можете полагаться на гарантии внутреннего модуля

## Недостатки

- Иногда может быть трудно найти подходящий интерфейс.
- Абстракция может вводить неэффективности.

## Примеры

- Крейт [`toolshed`](https://docs.rs/toolshed) содержит свои небезопасные операции в подмодулях, представляя безопасный интерфейс для пользователей.
- Класс `String` из `std` является оберткой над `Vec<u8>` с добавленным инвариантом, что содержимое должно быть действительным UTF-8. Операции над `String` гарантируют это поведение.
  Однако пользователи могут использовать `unsafe` метод для создания `String`, в этом случае на них лежит ответственность за гарантию действительности содержимого.

## Смотрите также

- [Блог Ральфа Юнга о инвариантах в небезопасном коде](https://www.ralfj.de/blog/2018/08/22/two-kinds-of-invariants.html)
